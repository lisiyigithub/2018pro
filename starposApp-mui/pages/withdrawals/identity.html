<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>身份验证</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/commonCss.css" rel="stylesheet" />
		<link href="../../css/identity.css" rel="stylesheet" />
		<!--<link rel="stylesheet" type="text/css" href="../../css/lexible_css.css" />-->
	</head>

	<body>
		<header class="mui-bar mui-bar-nav mn-head">
			<span onclick="javascript :history.back(-1);">
            <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-fanhuijiantou-copy"></use>
            </svg>
        </span>
			<h1 class="mui-title">身份验证</h1>
		</header>
		<div class="identity_out">
			<div onclick="pageidCardVerify()">
				<img src="../../img/jinjian_img_2@2x.png" id="front_img" />
				<p>点击上传身份证人像面</p>
			</div>
			<!--<div onclick="pageidCardVerify('back')">
				<img src="../../img/jinjian_img_3@2x.png" id="back_img" />
				<p>点击上传身份证国徽面</p>
			</div>-->
		</div>
		<div class="identity_ipt">
			<div style="position: relative;">
				<label>姓名</label>
				<input name="" id="name" placeholder="请输入姓名" readonly="readonly" />
				<img class="identity_img" src="../../img/icon_name.png" onclick="xiu()" style="position: absolute;right: 15px;top: 10px;" />
			</div>
			<div>
				<label>身份证号</label>
				<input type="" name="" id="id_code" placeholder="请输入身份证号" readonly="readonly" />
			</div>
		</div>
		<p style="margin: 12px 0 40px 15px; color: #666666;">请确认身份信息，如有误请修改</p>
		<div class="identity_bot">
			<button class="mui-btn mui-btn-outlined my-btn" onclick="goToSubmit()" disabled="disabled">下一步</button>
		</div>

	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/jquery-1.12.4.min.js"></script>
	<script src="../../js/utils.js"></script>
	<script src="../../js/storage.js"></script>
	<script src="../../js/flexible.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/font_489463_a1dgzv2r3pntrzfr.js"></script>
	<script src="../../js/raven.min.js" crossorigin="anonymous"></script>
	<!--<script type="text/javascript" src="../../js/eruda.min.js" ></script>-->
	<script type="text/javascript">
		mui.init();
		//eruda.init();
		Raven.config('http://3afafcc6e47a461eb7644f38e1f72553@sentry.starpos.com.cn:9000/18').install()
		var front_img_flag = 0
		var idcard_img;
		var idcard_name;
		var idcard_number;
		var repCode;
		var repMsg;
		//var back_img_flag = 0
		var merc_id = getUrlParams("merc_id")

		function xiu() {
			document.getElementById("name").removeAttribute("readonly");
		}

		function pageidCardVerify() {
			idCardVerify("front", merc_id)
		}
		//		mui("#name")[0].value = "11111"
		//		mui("#id_code")[0].value = "310115199309226012"
		//身份证识别回调
		function idCardVerifyResult(arg) {
			idcard_img = arg.idcard_img;
			idcard_name = arg.idcard_name;
			idcard_number = arg.idcard_number;
			repCode = arg.repCode;
			repMsg = arg.repMsg;
			console.log(arg)
			Raven.captureMessage("【arg】" + JSON.stringify(arg))
			//console.log(idcard_img)
			if(repCode == "000000") {
				if(idcard_img != null && idcard_img != undefined && idcard_img != '') {
					if(idcard_name != null && idcard_name != undefined && idcard_name != '') {
						front_img_flag = 1
						console.log(idcard_name + idcard_number)
						mui("#name")[0].value = idcard_name
						mui("#id_code")[0].value = idcard_number
						console.log(idcard_img + "idcard_img")
						var img_base64 = sha1_to_base64(idcard_img)
						console.log(img_base64 + "img_base64")
						document.getElementById('front_img').setAttribute('src', 'data:image/png;base64,' + img_base64);
					} else {
						//back_img_flag = 1
						var img_base64 = sha1_to_base64(idcard_img)
						console.log(img_base64 + "img_base64")
						document.getElementById('back_img').setAttribute('src', 'data:image/png;base64,' + img_base64);
					}
					//console.log("idcard_img："+idcard_img+"idcard_name："+idcard_name+"idcard_number："+idcard_number+"repCode："+repCode+"repMsg："+repMsg)
					if(front_img_flag == 1) {
						$('.mui-btn').prop("disabled", false);
					}
				} else {
					mui.toast("图片上传出错请重新上传")
				}
			} else {
				mui.toast(repMsg)
			}

		}

		function goToSubmit() {
			if(front_img_flag == 0) {
				mui.toast("请拍摄身份证正面照片")
				return;
			}
			//			if(back_img_flag == 0) {
			//				mui.toast("请拍摄身份证反面照片")
			//				return;
			//			}
			faceIdVerify(merc_id)
		}

		//活体识别回调
		function faceIdVerifyResult(arg) {
			var repCode = arg['repCode'];
			var repMsg = arg['repMsg'];
			console.log("repCode：" + repCode + "repMsg：" + repMsg)
			if(repCode == "000000") {
				var user_info = sessionFetch("user_info");
				sessionSave("face_flag", "1");
				mui.openWindow({
					url: 'index.html?usr_no=' + user_info.usr_no + '&usr_typ=' + user_info.usr_typ + '&token_id=' + user_info.token_id + '&version=' + user_info.version + '&opSys=' + user_info.opSys
				});
			} else if(repCode == "STM002") {
				var user_info = sessionFetch("user_info");
				mui.openWindow({
					url: 'Face_fail.html?usr_no=' + user_info.usr_no + '&usr_typ=' + user_info.usr_typ + '&token_id=' + user_info.token_id + '&version=' + user_info.version +
						'&opSys=' + user_info.opSys + '&merc_id=' + merc_id + '&flag=1'
				});
			} else {
				var user_info = sessionFetch("user_info");
				mui.openWindow({
					url: 'Face_fail.html?usr_no=' + user_info.usr_no + '&usr_typ=' + user_info.usr_typ + '&token_id=' + user_info.token_id + '&version=' + user_info.version +
						'&opSys=' + user_info.opSys + '&merc_id=' + merc_id + '&flag=0'
				});
			}

		}
	</script>

</html>